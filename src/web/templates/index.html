<!DOCTYPE html>
<html class="dark" lang="ru">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>VolleyMSK Analytics</title>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script>
tailwind.config = {
    darkMode: "class",
    theme: {
        extend: {
            colors: {
                "primary": "#6366f1",
                "bg-dark": "#0f1117",
                "surface": "#1a1d28",
                "surface-hover": "#252836",
                "input-bg": "#252836",
            },
            fontFamily: {
                "display": ["Inter", "sans-serif"]
            },
        },
    },
}
</script>
<style>
body { font-family: 'Inter', sans-serif; }
.scrollbar-hide::-webkit-scrollbar { display: none; }
.scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
@keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
.shimmer { animation: shimmer 2s infinite; }
@keyframes pulse-green { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
.pulse-dot { animation: pulse-green 2s infinite; }
.page { display: none; }
.page.active { display: block; }
.ref-tooltip { display: none; position: absolute; z-index: 40; pointer-events: none; }
tr:hover .ref-tooltip { display: block; }
</style>
</head>
<body class="bg-bg-dark text-white h-screen overflow-hidden flex font-display antialiased">

<!-- Sidebar -->
<aside class="w-[240px] flex-shrink-0 bg-surface border-r border-slate-800/50 flex flex-col h-full z-20">
    <div class="h-20 flex items-center px-6 gap-3 border-b border-slate-800/50">
        <div class="size-9 rounded-lg bg-gradient-to-br from-primary to-purple-600 flex items-center justify-center text-white shadow-lg shadow-primary/20">
            <span class="material-symbols-outlined text-[20px]">sports_volleyball</span>
        </div>
        <h1 class="text-lg font-bold tracking-tight text-white">VolleyMSK</h1>
    </div>
    <nav class="flex-1 px-4 py-6 flex flex-col gap-1 overflow-y-auto" id="nav">
        <a href="#" data-page="dashboard" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl transition-all group">
            <span class="material-symbols-outlined">dashboard</span>
            <span class="text-sm font-medium">Dashboard</span>
        </a>
        <a href="#" data-page="matches" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl transition-all group">
            <span class="material-symbols-outlined">sports_volleyball</span>
            <span class="text-sm font-medium">Матчи</span>
        </a>
        <a href="#" data-page="teams" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl transition-all group">
            <span class="material-symbols-outlined">groups</span>
            <span class="text-sm font-medium">Команды</span>
        </a>
        <a href="#" data-page="players" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl transition-all group">
            <span class="material-symbols-outlined">person</span>
            <span class="text-sm font-medium">Игроки</span>
        </a>
        <a href="#" data-page="referees" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl transition-all group">
            <span class="material-symbols-outlined">sports</span>
            <span class="text-sm font-medium">Судьи</span>
        </a>
        <a href="#" data-page="parsing" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl transition-all group">
            <span class="material-symbols-outlined">database</span>
            <span class="text-sm font-medium">Парсинг</span>
        </a>
    </nav>
</aside>

<!-- Main Content -->
<main class="flex-1 h-full overflow-y-auto overflow-x-hidden bg-bg-dark">
<div class="max-w-[1600px] mx-auto p-6">

<!-- ==================== DASHBOARD ==================== -->
<div id="page-dashboard" class="page active">
    <div class="grid grid-cols-4 gap-6 mb-6" id="kpi-cards"></div>
    <div class="flex gap-6 mb-6">
        <div class="w-[60%] bg-surface rounded-2xl p-6 shadow-lg border border-white/5">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="text-lg font-bold text-white">Динамика матчей</h2>
                    <p class="text-xs text-slate-400 mt-1">Количество игр по месяцам</p>
                </div>
                <div id="chart-year-btns" class="flex gap-1 flex-wrap justify-end"></div>
            </div>
            <div class="h-[250px] relative" id="chart-container">
                <svg id="chart-svg" class="w-full h-full"></svg>
                <div id="chart-tooltip" class="fixed z-50 bg-bg-dark border border-white/10 rounded-lg px-3 py-2 text-xs pointer-events-none shadow-xl" style="display:none;"></div>
            </div>
            <div id="chart-x-labels" class="flex justify-between mt-2 px-2 text-xs text-slate-500 font-medium"></div>
        </div>
        <div class="w-[40%] bg-surface rounded-2xl p-6 shadow-lg border border-white/5 flex flex-col items-center">
            <div class="w-full mb-2">
                <h2 class="text-lg font-bold text-white">Статистика базы</h2>
                <p class="text-xs text-slate-400 mt-1">Общие показатели</p>
            </div>
            <div class="flex-1 flex items-center justify-center w-full" id="db-stats-circle"></div>
        </div>
    </div>
    <div class="grid grid-cols-2 gap-6">
        <div class="bg-surface rounded-2xl shadow-lg border border-white/5 overflow-hidden">
            <div class="p-6 border-b border-white/5 flex justify-between items-center">
                <div><h2 class="text-lg font-bold text-white">Топ игроков</h2><p class="text-xs text-slate-400 mt-1">По количеству наград MVP</p></div>
                <a href="#" data-page="players" class="text-xs font-medium text-primary hover:text-primary/80 bg-primary/10 px-3 py-1.5 rounded-lg nav-item">Все игроки</a>
            </div>
            <div id="top-players-table"></div>
        </div>
        <div class="bg-surface rounded-2xl shadow-lg border border-white/5 overflow-hidden">
            <div class="p-6 border-b border-white/5 flex justify-between items-center">
                <div><h2 class="text-lg font-bold text-white">Топ судей</h2><p class="text-xs text-slate-400 mt-1">По средней оценке</p></div>
                <a href="#" data-page="referees" class="text-xs font-medium text-primary hover:text-primary/80 bg-primary/10 px-3 py-1.5 rounded-lg nav-item">Все судьи</a>
            </div>
            <div id="top-referees-table"></div>
        </div>
    </div>
</div>

<!-- ==================== MATCHES ==================== -->
<div id="page-matches" class="page">
    <div class="flex justify-between items-start mb-6">
        <div><h1 class="text-2xl font-bold">Матчи</h1><p class="text-sm text-slate-400 mt-1">История всех матчей</p></div>
        <input type="text" id="match-search" placeholder="Поиск по команде..." class="bg-input-bg border-0 rounded-xl px-4 py-2.5 text-sm text-white placeholder-slate-500 focus:ring-2 focus:ring-primary w-64"/>
    </div>
    <div class="bg-surface rounded-2xl shadow-lg border border-white/5 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm">
                <thead class="bg-white/5 text-slate-400 uppercase text-xs tracking-wider">
                    <tr><th class="px-4 py-4 w-16">#</th><th class="px-4 py-4">Дата</th><th class="px-4 py-4">Хозяева</th><th class="px-4 py-4 text-center w-24">Счёт</th><th class="px-4 py-4">Гости</th><th class="px-4 py-4">Сеты</th><th class="px-4 py-4">Судья</th></tr>
                </thead>
                <tbody id="matches-tbody" class="divide-y divide-white/5 text-slate-300"></tbody>
            </table>
        </div>
    </div>
    <div class="flex justify-between items-center mt-4" id="matches-pagination"></div>
</div>

<!-- ==================== TEAMS ==================== -->
<div id="page-teams" class="page">
    <div class="flex justify-between items-start mb-6">
        <div><h1 class="text-2xl font-bold">Команды</h1><p class="text-sm text-slate-400 mt-1">Все команды лиги</p></div>
        <input type="text" id="teams-search" placeholder="Поиск команды..." class="bg-input-bg border-0 rounded-xl px-4 py-2.5 text-sm text-white placeholder-slate-500 focus:ring-2 focus:ring-primary w-64"/>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6" id="teams-grid"></div>
</div>

<!-- ==================== PLAYERS ==================== -->
<div id="page-players" class="page">
    <div class="flex justify-between items-start mb-6">
        <div><h1 class="text-2xl font-bold">Игроки</h1><p class="text-sm text-slate-400 mt-1">База игроков</p></div>
        <input type="text" id="players-search" placeholder="Поиск игрока..." class="bg-input-bg border-0 rounded-xl px-4 py-2.5 text-sm text-white placeholder-slate-500 focus:ring-2 focus:ring-primary w-64"/>
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="players-grid"></div>
    <div class="flex justify-center mt-6" id="players-pagination"></div>
</div>

<!-- ==================== REFEREES ==================== -->
<div id="page-referees" class="page">
    <div class="flex justify-between items-start mb-6">
        <div><h1 class="text-2xl font-bold">Судьи</h1><p class="text-sm text-slate-400 mt-1">Рейтинг судей лиги</p></div>
        <input type="text" id="referees-search" placeholder="Поиск судьи..." class="bg-input-bg border-0 rounded-xl px-4 py-2.5 text-sm text-white placeholder-slate-500 focus:ring-2 focus:ring-primary w-64"/>
    </div>
    <div class="bg-surface rounded-2xl shadow-lg border border-white/5 overflow-hidden">
        <table class="w-full text-left text-sm">
            <thead class="bg-white/5 text-slate-400 uppercase text-xs tracking-wider">
                <tr><th class="px-6 py-4 w-16">#</th><th class="px-6 py-4">Судья</th><th class="px-6 py-4 text-center">Матчей</th><th class="px-6 py-4 text-right">Рейтинг</th></tr>
            </thead>
            <tbody id="referees-tbody" class="divide-y divide-white/5 text-slate-300"></tbody>
        </table>
    </div>
</div>

<!-- ==================== PARSING ==================== -->
<div id="page-parsing" class="page">
    <div class="mb-6"><h1 class="text-2xl font-bold">Управление парсингом</h1><p class="text-sm text-slate-400 mt-1">Импорт данных с volleymsk.ru</p></div>
    <div class="grid grid-cols-2 gap-6 mb-6">
        <div class="bg-surface p-6 rounded-2xl border border-white/5 flex flex-col">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center text-primary"><span class="material-symbols-outlined">scoreboard</span></div>
                <div><h3 class="text-lg font-bold">Парсинг матчей</h3><p class="text-sm text-slate-400">Загрузка результатов</p></div>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <label class="flex flex-col gap-2"><span class="text-xs font-medium uppercase tracking-wide text-slate-400">Начальный ID</span><input type="number" id="parse-match-start" value="1" class="bg-input-bg border-0 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-primary"/></label>
                <label class="flex flex-col gap-2"><span class="text-xs font-medium uppercase tracking-wide text-slate-400">Конечный ID</span><input type="number" id="parse-match-end" value="50000" class="bg-input-bg border-0 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-primary"/></label>
            </div>
            <div class="flex items-center gap-3 mb-6">
                <input type="checkbox" id="parse-skip-existing" checked class="rounded bg-input-bg border-slate-600 text-primary focus:ring-primary"/>
                <span class="text-sm">Пропускать существующие</span>
            </div>
            <button id="btn-parse-matches" class="w-full bg-gradient-to-r from-primary to-indigo-600 text-white font-bold py-3.5 px-6 rounded-lg shadow-lg shadow-primary/25 flex items-center justify-center gap-2 hover:opacity-90 transition">
                <span class="material-symbols-outlined text-[20px]">play_arrow</span> Начать парсинг матчей
            </button>
        </div>
        <div class="bg-surface p-6 rounded-2xl border border-white/5 flex flex-col">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 rounded-lg bg-cyan-500/10 flex items-center justify-center text-cyan-400"><span class="material-symbols-outlined">group_add</span></div>
                <div><h3 class="text-lg font-bold">Парсинг составов</h3><p class="text-sm text-slate-400">Загрузка игроков команд</p></div>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <label class="flex flex-col gap-2"><span class="text-xs font-medium uppercase tracking-wide text-slate-400">Начальный ID</span><input type="number" id="parse-roster-start" value="1" class="bg-input-bg border-0 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-primary"/></label>
                <label class="flex flex-col gap-2"><span class="text-xs font-medium uppercase tracking-wide text-slate-400">Конечный ID</span><input type="number" id="parse-roster-end" value="1000" class="bg-input-bg border-0 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-primary"/></label>
            </div>
            <div class="flex-1"></div>
            <button id="btn-parse-rosters" class="w-full bg-gradient-to-r from-cyan-500 to-cyan-600 text-white font-bold py-3.5 px-6 rounded-lg shadow-lg shadow-cyan-500/25 flex items-center justify-center gap-2 hover:opacity-90 transition">
                <span class="material-symbols-outlined text-[20px]">play_arrow</span> Начать парсинг составов
            </button>
        </div>
    </div>
    <div id="parse-progress" class="bg-surface rounded-2xl border border-white/5 p-6 mb-6" style="display:none;">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
                <div id="parse-status-badge" class="flex gap-2 px-3 py-1 rounded-full bg-emerald-500/10 border border-emerald-500/20">
                    <span class="relative flex h-2.5 w-2.5 my-auto"><span class="pulse-dot absolute h-full w-full rounded-full bg-emerald-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-emerald-500"></span></span>
                    <span id="parse-status-text" class="text-xs font-bold text-emerald-500 uppercase">Выполняется</span>
                </div>
                <span class="text-sm text-slate-400">Тип: <span id="parse-job-type" class="text-white font-medium">-</span></span>
            </div>
            <div class="flex gap-2">
                <button id="btn-pause" class="px-4 py-2 rounded-lg border border-amber-500/30 text-amber-400 text-sm font-medium hover:bg-amber-500/10 transition flex items-center gap-1" style="display:none;"><span class="material-symbols-outlined text-[16px]">pause</span> Пауза</button>
                <button id="btn-resume" class="px-4 py-2 rounded-lg border border-emerald-500/30 text-emerald-400 text-sm font-medium hover:bg-emerald-500/10 transition flex items-center gap-1" style="display:none;"><span class="material-symbols-outlined text-[16px]">play_arrow</span> Продолжить</button>
                <button id="btn-stop" class="px-4 py-2 rounded-lg border border-red-500/30 text-red-400 text-sm font-medium hover:bg-red-500/10 transition flex items-center gap-1" style="display:none;"><span class="material-symbols-outlined text-[16px]">stop</span> Остановить</button>
            </div>
        </div>
        <div class="w-full bg-slate-800 rounded-full h-4 overflow-hidden mb-4">
            <div id="parse-bar" class="bg-gradient-to-r from-primary to-indigo-400 h-4 rounded-full relative transition-all duration-300" style="width:0%">
                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent shimmer"></div>
            </div>
        </div>
        <div class="grid grid-cols-4 gap-4 text-sm">
            <div><span class="text-slate-400">Текущий:</span> <span id="parse-current" class="text-white font-bold">0</span> / <span id="parse-end" class="text-slate-400">0</span></div>
            <div><span class="text-slate-400">Обработано:</span> <span id="parse-parsed" class="text-emerald-400 font-bold">0</span></div>
            <div><span class="text-slate-400">Ошибок:</span> <span id="parse-errors" class="text-red-400 font-bold">0</span></div>
            <div><span class="text-slate-400">Прогресс:</span> <span id="parse-percent" class="text-white font-bold">0%</span></div>
        </div>
        <div id="parse-last-error" class="mt-3 text-xs text-red-400/80 truncate"></div>
    </div>
    <div class="bg-surface rounded-2xl border border-white/5 p-6">
        <h3 class="text-sm font-bold uppercase tracking-wider text-slate-400 mb-4">База данных</h3>
        <div class="grid grid-cols-4 gap-6" id="parse-db-stats"></div>
    </div>
</div>

<!-- ==================== DETAIL MODAL ==================== -->
<div id="detail-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center" style="display:none;" onclick="if(event.target===this)this.style.display='none'">
    <div class="bg-surface rounded-2xl border border-white/5 shadow-2xl w-[90%] max-w-[800px] max-h-[85vh] overflow-y-auto p-8">
        <div class="flex justify-between items-center mb-6">
            <h2 id="modal-title" class="text-xl font-bold"></h2>
            <button onclick="document.getElementById('detail-modal').style.display='none'" class="text-slate-400 hover:text-white"><span class="material-symbols-outlined">close</span></button>
        </div>
        <div id="modal-content"></div>
    </div>
</div>

</div>
</main>

<script>
async function api(url) { return (await fetch(url)).json(); }
async function apiPost(url, data = {}) {
    return (await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })).json();
}

let currentPage = 'dashboard';
const pageLoaders = { dashboard: loadDashboard, matches: loadMatches, teams: loadTeams, players: loadPlayers, referees: loadReferees, parsing: loadParsing };

document.querySelectorAll('.nav-item').forEach(el => {
    el.addEventListener('click', e => { e.preventDefault(); navigateTo(el.dataset.page); });
});

function navigateTo(page) {
    currentPage = page;
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-' + page).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n => {
        n.className = n.dataset.page === page
            ? 'nav-item flex items-center gap-3 px-4 py-3 rounded-xl bg-primary text-white shadow-lg shadow-primary/25 transition-all group'
            : 'nav-item flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 transition-colors group';
    });
    if (pageLoaders[page]) pageLoaders[page]();
}

async function loadDashboard() {
    const stats = await api('/api/stats');
    const kpis = [
        { icon: 'sports_volleyball', label: 'Матчи', value: stats.matches?.toLocaleString() || '0', color: 'primary', bg: 'bg-primary/10', text: 'text-primary' },
        { icon: 'person', label: 'Игроки', value: stats.players?.toLocaleString() || '0', color: 'cyan', bg: 'bg-cyan-400/10', text: 'text-cyan-400' },
        { icon: 'groups', label: 'Команды', value: stats.teams?.toLocaleString() || '0', color: 'purple', bg: 'bg-purple-500/10', text: 'text-purple-500' },
        { icon: 'sports', label: 'Судьи', value: stats.referees?.toLocaleString() || '0', color: 'orange', bg: 'bg-orange-500/10', text: 'text-orange-500' },
    ];
    document.getElementById('kpi-cards').innerHTML = kpis.map(k => `
        <div class="bg-surface rounded-2xl p-6 shadow-lg border border-white/5 flex flex-col justify-between h-36 relative overflow-hidden group">
            <div class="${k.bg} ${k.text} p-2 rounded-lg w-fit"><span class="material-symbols-outlined text-2xl">${k.icon}</span></div>
            <div><p class="text-slate-400 text-sm font-medium mb-1">${k.label}</p><p class="text-3xl font-bold text-white tracking-tight">${k.value}</p></div>
        </div>
    `).join('');
    document.getElementById('db-stats-circle').innerHTML = `<div class="grid grid-cols-2 gap-4 w-full">${kpis.map(k => `
        <div class="text-center p-4 bg-bg-dark rounded-xl"><span class="material-symbols-outlined ${k.text} text-2xl mb-2">${k.icon}</span><p class="text-2xl font-bold text-white">${k.value}</p><p class="text-xs text-slate-400 mt-1">${k.label}</p></div>
    `).join('')}</div>`;
    const playersData = await api('/api/players?per_page=10&sort=mvp');
    document.getElementById('top-players-table').innerHTML = `<table class="w-full text-sm"><thead class="bg-white/5 text-slate-400 uppercase text-xs tracking-wider"><tr><th class="px-6 py-3">#</th><th class="px-6 py-3">Игрок</th><th class="px-6 py-3 text-center">Матчей</th><th class="px-6 py-3 text-right">MVP</th></tr></thead><tbody class="divide-y divide-white/5">${playersData.players.map((p, i) => `
        <tr class="hover:bg-white/5 transition-colors cursor-pointer" onclick="showPlayerDetail(${p.id})"><td class="px-6 py-3 font-bold ${i < 3 ? 'text-amber-400' : 'text-slate-500'}">${i + 1}</td><td class="px-6 py-3"><span class="font-semibold text-white">${p.full_name}</span></td><td class="px-6 py-3 text-center text-slate-400">${p.match_count}</td><td class="px-6 py-3 text-right font-bold text-amber-400">${p.mvp_count}</td></tr>
    `).join('')}</tbody></table>`;
    const refsData = await api('/api/referees');
    document.getElementById('top-referees-table').innerHTML = `<table class="w-full text-sm"><thead class="bg-white/5 text-slate-400 uppercase text-xs tracking-wider"><tr><th class="px-6 py-3">#</th><th class="px-6 py-3">Судья</th><th class="px-6 py-3 text-center">Матчей</th><th class="px-6 py-3 text-right">Рейтинг</th></tr></thead><tbody class="divide-y divide-white/5">${refsData.referees.slice(0, 10).map((r, i) => {
        const rc = r.avg_rating >= 4 ? 'text-emerald-400' : r.avg_rating >= 3 ? 'text-amber-400' : r.avg_rating ? 'text-red-400' : 'text-slate-500';
        return `<tr class="hover:bg-white/5 transition-colors cursor-pointer"><td class="px-6 py-3 font-bold ${i < 3 ? 'text-amber-400' : 'text-slate-500'}">${i + 1}</td><td class="px-6 py-3"><div class="flex items-center gap-3"><div class="size-8 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold text-slate-300">${r.full_name.split(' ').map(n => n[0]).join('').slice(0, 2)}</div><span class="font-semibold text-white">${r.full_name}</span></div></td><td class="px-6 py-3 text-center font-medium">${r.match_count}</td><td class="px-6 py-3 text-right ${rc} font-medium">${r.avg_rating != null ? r.avg_rating : '-'}</td></tr>`;
    }).join('')}</tbody></table>`;
    // Load chart
    loadChart();
}

let chartData = null;
let chartYear = 'all';
async function loadChart() {
    if (!chartData) chartData = await api('/api/stats/monthly');
    const years = chartData.years;
    // Year filter buttons
    document.getElementById('chart-year-btns').innerHTML = `<button onclick="setChartYear('all')" class="px-2.5 py-1 rounded-lg text-xs font-medium ${chartYear === 'all' ? 'bg-primary text-white' : 'bg-white/5 text-slate-400 hover:bg-white/10'} transition">Все</button>` + years.map(y => `<button onclick="setChartYear(${y})" class="px-2.5 py-1 rounded-lg text-xs font-medium ${chartYear === y ? 'bg-primary text-white' : 'bg-white/5 text-slate-400 hover:bg-white/10'} transition">${y}</button>`).join('');
    // Filter data
    let points;
    const monthNames = ['Янв','Фев','Мар','Апр','Май','Июн','Июл','Авг','Сен','Окт','Ноя','Дек'];
    if (chartYear === 'all') {
        // Group by year-month across all years, show all months chronologically
        points = chartData.data.map(d => ({ label: `${monthNames[d.month-1]} ${d.year}`, count: d.count, month: d.month, year: d.year }));
    } else {
        // Show 12 months for selected year, fill gaps with 0
        points = [];
        for (let m = 1; m <= 12; m++) {
            const found = chartData.data.find(d => d.year === chartYear && d.month === m);
            points.push({ label: monthNames[m-1], count: found ? found.count : 0, month: m, year: chartYear });
        }
    }
    if (!points.length) return;
    renderChart(points);
}
function setChartYear(y) { chartYear = y; loadChart(); }

function renderChart(points) {
    const svg = document.getElementById('chart-svg');
    const container = document.getElementById('chart-container');
    const W = container.clientWidth;
    const H = 250;
    const pad = { top: 20, right: 10, bottom: 5, left: 40 };
    const cw = W - pad.left - pad.right;
    const ch = H - pad.top - pad.bottom;
    const maxVal = Math.max(...points.map(p => p.count), 1);
    // Round up maxVal for nice grid lines
    const gridMax = Math.ceil(maxVal / 50) * 50 || 50;
    const xStep = cw / Math.max(points.length - 1, 1);
    const coords = points.map((p, i) => ({ x: pad.left + i * xStep, y: pad.top + ch - (p.count / gridMax) * ch, ...p }));

    // Build SVG
    let svgContent = `<defs><linearGradient id="areaGrad" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#22d3ee" stop-opacity="0.3"/><stop offset="100%" stop-color="#22d3ee" stop-opacity="0"/></linearGradient></defs>`;
    // Grid lines + labels
    for (let i = 0; i <= 4; i++) {
        const yy = pad.top + ch - (i / 4) * ch;
        const val = Math.round(gridMax * i / 4);
        svgContent += `<line x1="${pad.left}" x2="${W - pad.right}" y1="${yy}" y2="${yy}" stroke="#94a3b8" stroke-dasharray="4 4" opacity="0.1"/>`;
        svgContent += `<text x="${pad.left - 6}" y="${yy + 4}" fill="#64748b" font-size="10" text-anchor="end">${val}</text>`;
    }
    // Area + line path
    if (coords.length > 1) {
        const linePts = coords.map(c => `${c.x},${c.y}`).join(' L');
        const areaPath = `M${coords[0].x},${coords[0].y} L${linePts} L${coords[coords.length-1].x},${pad.top + ch} L${coords[0].x},${pad.top + ch} Z`;
        svgContent += `<path d="${areaPath}" fill="url(#areaGrad)"/>`;
        svgContent += `<path d="M${linePts}" fill="none" stroke="#22d3ee" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"/>`;
    }
    // Invisible hover areas + dots
    coords.forEach((c, i) => {
        svgContent += `<circle cx="${c.x}" cy="${c.y}" r="3.5" fill="#22d3ee" stroke="#1a1d28" stroke-width="2" opacity="0"/>`;
        svgContent += `<rect x="${c.x - xStep/2}" y="${pad.top}" width="${xStep}" height="${ch}" fill="transparent" class="chart-hover-area" data-idx="${i}"/>`;
    });
    svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
    svg.setAttribute('preserveAspectRatio', 'none');
    svg.innerHTML = svgContent;

    // X labels
    const labelsEl = document.getElementById('chart-x-labels');
    if (chartYear !== 'all' || points.length <= 24) {
        const step = points.length > 12 ? Math.ceil(points.length / 12) : 1;
        labelsEl.innerHTML = points.filter((_, i) => i % step === 0).map(p => `<span>${p.label}</span>`).join('');
    } else {
        // Show just years for "all" with many points
        const shownYears = [...new Set(points.map(p => p.year))];
        labelsEl.innerHTML = shownYears.map(y => `<span>${y}</span>`).join('');
    }

    // Tooltip interaction
    const tooltip = document.getElementById('chart-tooltip');
    const circles = svg.querySelectorAll('circle');
    svg.querySelectorAll('.chart-hover-area').forEach(rect => {
        rect.addEventListener('mouseenter', e => {
            const idx = +e.target.dataset.idx;
            const c = coords[idx];
            circles[idx].setAttribute('opacity', '1');
            const svgRect = svg.getBoundingClientRect();
            const tipX = svgRect.left + (c.x / W) * svgRect.width;
            const tipY = svgRect.top + (c.y / H) * svgRect.height;
            tooltip.innerHTML = `<span class="text-white font-bold">${c.count}</span> <span class="text-slate-400">матчей</span><br><span class="text-slate-500">${c.label}</span>`;
            tooltip.style.display = 'block';
            tooltip.style.left = (tipX - 40) + 'px';
            tooltip.style.top = (tipY - 52) + 'px';
        });
        rect.addEventListener('mouseleave', e => {
            const idx = +e.target.dataset.idx;
            circles[idx].setAttribute('opacity', '0');
            tooltip.style.display = 'none';
        });
    });
}

let matchesPage = 1;
async function loadMatches(page = 1) {
    matchesPage = page;
    const search = document.getElementById('match-search')?.value || '';
    const data = await api(`/api/matches?page=${page}&per_page=20${search ? '&search=' + encodeURIComponent(search) : ''}`);
    document.getElementById('matches-tbody').innerHTML = data.matches.map(m => {
        const hw = m.home_score > m.away_score;
        return `<tr class="hover:bg-white/5 transition-colors cursor-pointer" onclick="showMatchDetail(${m.id})"><td class="px-4 py-3 text-slate-500 text-xs">${m.site_id}</td><td class="px-4 py-3 text-slate-400">${m.date_time ? new Date(m.date_time).toLocaleDateString('ru') : '-'}</td><td class="px-4 py-3 ${hw ? 'text-white font-bold' : 'text-slate-400'}">${m.home_team || '-'}</td><td class="px-4 py-3 text-center"><span class="${hw ? 'text-emerald-400' : 'text-red-400'} font-bold text-lg">${m.home_score ?? '-'}</span><span class="text-slate-500 mx-1">:</span><span class="${!hw ? 'text-emerald-400' : 'text-red-400'} font-bold text-lg">${m.away_score ?? '-'}</span></td><td class="px-4 py-3 ${!hw ? 'text-white font-bold' : 'text-slate-400'}">${m.away_team || '-'}</td><td class="px-4 py-3 text-slate-500 text-xs">${m.set_scores || '-'}</td><td class="px-4 py-3 text-cyan-400 text-xs">${m.referee || '-'}</td></tr>`;
    }).join('');
    const tp = data.pages;
    document.getElementById('matches-pagination').innerHTML = `<span class="text-sm text-slate-400">Показано ${(page-1)*20+1}-${Math.min(page*20, data.total)} из ${data.total}</span><div class="flex gap-1">${page > 1 ? `<button onclick="loadMatches(${page-1})" class="px-3 py-1.5 rounded-lg bg-white/5 text-slate-400 hover:bg-white/10 text-sm">Назад</button>` : ''}${[...Array(Math.min(7, tp))].map((_, i) => { let p = i + 1; if (tp > 7) { if (page <= 4) p = i + 1; else if (page >= tp - 3) p = tp - 6 + i; else p = page - 3 + i; } return `<button onclick="loadMatches(${p})" class="px-3 py-1.5 rounded-lg text-sm ${p === page ? 'bg-primary text-white' : 'bg-white/5 text-slate-400 hover:bg-white/10'}">${p}</button>`; }).join('')}${page < tp ? `<button onclick="loadMatches(${page+1})" class="px-3 py-1.5 rounded-lg bg-white/5 text-slate-400 hover:bg-white/10 text-sm">Далее</button>` : ''}</div>`;
}

async function loadTeams() {
    const search = document.getElementById('teams-search')?.value || '';
    const data = await api(search ? `/api/teams?search=${encodeURIComponent(search)}` : '/api/teams');
    document.getElementById('teams-grid').innerHTML = data.teams.map(t => `
        <article class="group bg-surface rounded-2xl p-6 border border-white/5 hover:border-primary/50 hover:-translate-y-1 transition-all cursor-pointer" onclick="showTeamDetail(${t.id})">
            <div class="flex items-center gap-4 mb-4"><div class="w-12 h-12 rounded-lg bg-primary/10 flex items-center justify-center text-primary"><span class="material-symbols-outlined text-2xl">groups</span></div><div><h3 class="font-bold text-lg text-white">${t.name}</h3><p class="text-sm text-slate-500">ID: ${t.site_id}</p></div></div>
            <div class="text-xs text-slate-400">Нажмите для подробностей</div>
        </article>
    `).join('');
}

let playersPage = 1;
async function loadPlayers(page = 1) {
    playersPage = page;
    const search = document.getElementById('players-search')?.value || '';
    let url = `/api/players?page=${page}&per_page=20`; if (search) url += `&search=${encodeURIComponent(search)}`;
    const data = await api(url);
    document.getElementById('players-grid').innerHTML = data.players.map(p => `
        <div class="group bg-surface rounded-2xl p-5 border border-white/5 hover:border-primary/50 hover:-translate-y-1 transition-all cursor-pointer" onclick="showPlayerDetail(${p.id})">
            <div class="w-16 h-16 rounded-full bg-slate-700 flex items-center justify-center text-xl font-bold text-slate-400 border-2 border-white/10 mb-4">${p.full_name.split(' ').map(n => n[0]).join('').slice(0, 2)}</div>
            <h3 class="text-lg font-bold text-white mb-0.5">${p.full_name}</h3>
            <p class="text-sm text-slate-500 mb-4">${p.position || ''} ${p.birth_year ? '(' + p.birth_year + ')' : ''}</p>
            <div class="grid grid-cols-3 gap-2 pt-3 border-t border-white/5 text-center"><div><div class="text-xs text-slate-500 mb-1">Рост</div><div class="text-sm font-bold text-white">${p.height || '-'}</div></div><div><div class="text-xs text-slate-500 mb-1">Матчей</div><div class="text-sm font-bold text-white">${p.match_count || 0}</div></div><div><div class="text-xs text-slate-500 mb-1">MVP</div><div class="text-sm font-bold text-amber-400">${p.mvp_count || 0}</div></div></div>
        </div>
    `).join('');
    const tp = Math.ceil(data.total / 20);
    document.getElementById('players-pagination').innerHTML = `<div class="flex gap-1 items-center">${page > 1 ? `<button onclick="loadPlayers(${page-1})" class="px-3 py-1.5 rounded-lg bg-white/5 text-slate-400 hover:bg-white/10 text-sm">Назад</button>` : ''}<span class="text-sm text-slate-400 mx-3">Стр. ${page} из ${tp}</span>${page < tp ? `<button onclick="loadPlayers(${page+1})" class="px-3 py-1.5 rounded-lg bg-white/5 text-slate-400 hover:bg-white/10 text-sm">Далее</button>` : ''}</div>`;
}

// Referee tooltip cache
const refTooltipCache = {};
async function loadReferees() {
    const search = document.getElementById('referees-search')?.value || '';
    const data = await api(search ? `/api/referees?search=${encodeURIComponent(search)}` : '/api/referees');
    document.getElementById('referees-tbody').innerHTML = data.referees.map((r, i) => {
        const ini = r.full_name.split(' ').map(n => n[0]).join('').slice(0, 2);
        const rc = i === 0 ? 'text-amber-400' : i === 1 ? 'text-slate-300' : i === 2 ? 'text-amber-700' : 'text-slate-600';
        const ratingColor = r.avg_rating >= 4 ? 'text-emerald-400' : r.avg_rating >= 3 ? 'text-amber-400' : r.avg_rating ? 'text-red-400' : 'text-slate-500';
        return `<tr class="hover:bg-white/5 transition-colors cursor-pointer relative" onclick="showRefereeDetail(${r.id})" onmouseenter="showRefTooltip(event,${r.id})" onmouseleave="hideRefTooltip()"><td class="px-6 py-4 font-bold ${rc}">${i < 3 ? '<span class="material-symbols-outlined text-sm" style="font-variation-settings:\'FILL\' 1">emoji_events</span>' : (i + 1)}</td><td class="px-6 py-4"><div class="flex items-center gap-3"><div class="size-8 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold text-slate-300">${ini}</div><span class="font-semibold text-white">${r.full_name}</span></div></td><td class="px-6 py-4 text-center font-medium">${r.match_count || 0}</td><td class="px-6 py-4 text-right ${ratingColor} font-medium">${r.avg_rating != null ? r.avg_rating : '-'}</td></tr>`;
    }).join('');
}

let refTooltipEl = null;
function hideRefTooltip() { if (refTooltipEl) { refTooltipEl.remove(); refTooltipEl = null; } }
async function showRefTooltip(e, refId) {
    hideRefTooltip();
    const tr = e.currentTarget;
    const rect = tr.getBoundingClientRect();
    // Create tooltip
    refTooltipEl = document.createElement('div');
    refTooltipEl.className = 'fixed z-50 bg-surface border border-white/10 rounded-xl shadow-2xl p-4 w-[340px] pointer-events-none';
    refTooltipEl.style.left = (rect.right - 360) + 'px';
    refTooltipEl.style.top = (rect.bottom + 4) + 'px';
    refTooltipEl.innerHTML = '<div class="flex items-center gap-2 text-slate-400 text-xs"><span class="material-symbols-outlined text-sm">hourglass_top</span>Загрузка...</div>';
    document.body.appendChild(refTooltipEl);
    // Fetch data
    if (!refTooltipCache[refId]) {
        try { refTooltipCache[refId] = await api(`/api/referees/${refId}`); } catch(e) { hideRefTooltip(); return; }
    }
    if (!refTooltipEl) return; // user already moved away
    const d = refTooltipCache[refId];
    const last5 = d.matches.slice(0, 5);
    const fd = iso => iso ? new Date(iso).toLocaleDateString('ru') : '-';
    refTooltipEl.innerHTML = `
        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Последние матчи</p>
        ${last5.length ? last5.map(m => `<div class="flex items-center gap-2 text-xs py-1.5 border-b border-white/5 last:border-0">
            <span class="text-slate-500 w-[70px] shrink-0">${fd(m.date_time)}</span>
            <span class="text-white truncate flex-1">${m.home_team} <span class="text-slate-500">vs</span> ${m.away_team}</span>
            <span class="font-bold ${m.home_score > m.away_score ? 'text-emerald-400' : 'text-red-400'} shrink-0">${m.home_score}:${m.away_score}</span>
            ${m.rating_home != null || m.rating_away != null ? `<span class="text-amber-400 shrink-0">${[m.rating_home, m.rating_away].filter(x => x != null).join('/')}</span>` : ''}
        </div>`).join('') : '<p class="text-xs text-slate-500">Нет матчей</p>'}
        <p class="text-[10px] text-slate-500 mt-2 text-center">Нажмите для просмотра профиля</p>`;
    // Reposition if goes off screen
    const tipRect = refTooltipEl.getBoundingClientRect();
    if (tipRect.bottom > window.innerHeight) refTooltipEl.style.top = (rect.top - tipRect.height - 4) + 'px';
    if (tipRect.left < 0) refTooltipEl.style.left = '8px';
}

async function showRefereeDetail(id) {
    hideRefTooltip();
    const d = refTooltipCache[id] || await api(`/api/referees/${id}`);
    refTooltipCache[id] = d;
    document.getElementById('modal-title').textContent = d.full_name;
    const fd = iso => iso ? new Date(iso).toLocaleDateString('ru') : '-';
    const s = d.stats;
    const rc = s.avg_rating >= 4 ? 'text-emerald-400' : s.avg_rating >= 3 ? 'text-amber-400' : s.avg_rating ? 'text-red-400' : 'text-slate-500';
    // Rating distribution bar
    const total = s.total_ratings || 1;
    const bars = [
        { n: 5, count: s.rating_5, color: 'bg-emerald-500' },
        { n: 4, count: s.rating_4, color: 'bg-emerald-400' },
        { n: 3, count: s.rating_3, color: 'bg-amber-400' },
        { n: 2, count: s.rating_2, color: 'bg-orange-500' },
        { n: 1, count: s.rating_1, color: 'bg-red-500' },
    ];
    document.getElementById('modal-content').innerHTML = `
        <div class="flex items-center gap-4 mb-6">
            <div class="size-16 rounded-full bg-slate-700 flex items-center justify-center text-2xl font-bold text-slate-300 border-2 border-white/10">${d.full_name.split(' ').map(n=>n[0]).join('').slice(0,2)}</div>
            <div>
                <p class="text-xl font-bold text-white">${d.full_name}</p>
                <p class="text-sm text-slate-400 mt-1"><span class="material-symbols-outlined text-sm align-middle">sports</span> Судья</p>
            </div>
        </div>
        <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="text-center p-4 bg-bg-dark rounded-xl"><p class="text-2xl font-bold text-white">${s.total_matches}</p><p class="text-xs text-slate-500 mt-1">Матчей</p></div>
            <div class="text-center p-4 bg-bg-dark rounded-xl"><p class="text-2xl font-bold ${rc}">${s.avg_rating || '-'}</p><p class="text-xs text-slate-500 mt-1">Средний рейтинг</p></div>
            <div class="text-center p-4 bg-bg-dark rounded-xl"><p class="text-2xl font-bold text-white">${s.total_ratings}</p><p class="text-xs text-slate-500 mt-1">Оценок</p></div>
        </div>
        <div class="bg-bg-dark rounded-xl p-4 mb-6">
            <h3 class="font-bold text-sm mb-3">Распределение оценок</h3>
            ${bars.map(b => `<div class="flex items-center gap-3 mb-1.5"><span class="text-xs text-slate-400 w-4 text-right">${b.n}</span><div class="flex-1 h-4 bg-black/20 rounded-full overflow-hidden"><div class="${b.color} h-full rounded-full" style="width:${Math.round(b.count/total*100)}%"></div></div><span class="text-xs text-slate-500 w-8">${b.count}</span></div>`).join('')}
        </div>
        <div class="flex items-center gap-3 mb-3">
            <h3 class="font-bold">Матчи (${d.matches.length})</h3>
            <input type="text" id="ref-match-search" placeholder="Поиск по команде..." class="bg-input-bg border-0 rounded-lg px-3 py-1.5 text-xs text-white placeholder-slate-500 focus:ring-2 focus:ring-primary w-48 ml-auto"/>
        </div>
        <div id="ref-matches-list" class="max-h-[300px] overflow-y-auto space-y-1"></div>`;
    // Render matches and setup search
    const renderRefMatches = (filter) => {
        const f = (filter || '').toLowerCase();
        const filtered = f ? d.matches.filter(m => m.home_team.toLowerCase().includes(f) || m.away_team.toLowerCase().includes(f)) : d.matches;
        document.getElementById('ref-matches-list').innerHTML = filtered.length ? filtered.map(m => `<div class="flex items-center gap-3 px-3 py-2 rounded-lg bg-white/[0.02] hover:bg-white/5 cursor-pointer text-sm" onclick="showMatchDetail(${m.id})">
            <span class="text-slate-500 w-[70px] shrink-0">${fd(m.date_time)}</span>
            <span class="text-white truncate flex-1">${m.home_team} <span class="text-slate-500 mx-1">vs</span> ${m.away_team}</span>
            <span class="font-bold shrink-0 ${m.home_score > m.away_score ? 'text-emerald-400' : m.home_score < m.away_score ? 'text-red-400' : 'text-slate-400'}">${m.home_score}:${m.away_score}</span>
            ${m.rating_home != null || m.rating_away != null ? `<span class="text-xs px-1.5 py-0.5 rounded bg-amber-500/10 text-amber-400 shrink-0">${[m.rating_home, m.rating_away].filter(x => x != null).join('/')}</span>` : ''}
        </div>`).join('') : '<p class="text-sm text-slate-500 text-center py-4">Ничего не найдено</p>';
    };
    renderRefMatches('');
    document.getElementById('ref-match-search').addEventListener('input', e => renderRefMatches(e.target.value));
    document.getElementById('detail-modal').style.display = 'flex';
}

async function showMatchDetail(id) {
    const d = await api(`/api/matches/${id}`);
    document.getElementById('modal-title').textContent = `Матч #${d.site_id}`;
    const fd = iso => iso ? new Date(iso).toLocaleString('ru') : '-';
    document.getElementById('modal-content').innerHTML = `
        <p class="text-slate-400 mb-4">${fd(d.date_time)} ${d.tournament_path ? '| ' + d.tournament_path : ''}</p>
        <div class="flex items-center justify-center gap-8 mb-6">
            <div class="text-center"><p class="text-lg font-bold text-white">${d.home_team?.name || '-'}</p><p class="text-xs text-slate-500">Хозяева</p></div>
            <div class="text-center"><p class="text-4xl font-black"><span class="${d.home_score > d.away_score ? 'text-emerald-400' : 'text-red-400'}">${d.home_score}</span><span class="text-slate-600 mx-2">:</span><span class="${d.away_score > d.home_score ? 'text-emerald-400' : 'text-red-400'}">${d.away_score}</span></p><p class="text-sm text-slate-500 mt-1">${d.set_scores || ''}</p></div>
            <div class="text-center"><p class="text-lg font-bold text-white">${d.away_team?.name || '-'}</p><p class="text-xs text-slate-500">Гости</p></div>
        </div>
        ${d.referee ? `<p class="text-sm text-slate-400 mb-4">Судья: <span class="text-cyan-400">${d.referee.full_name}</span></p>` : ''}
        ${d.home_roster?.length ? `<h3 class="font-bold mb-2 mt-4">${d.home_team?.name || 'Хозяева'}</h3><div class="flex flex-wrap gap-2 mb-4">${d.home_roster.map(p => `<span class="px-3 py-1 rounded-lg bg-white/5 text-sm cursor-pointer hover:bg-primary/20 transition" onclick="showPlayerDetail(${p.id})">${p.full_name}</span>`).join('')}</div>` : ''}
        ${d.away_roster?.length ? `<h3 class="font-bold mb-2">${d.away_team?.name || 'Гости'}</h3><div class="flex flex-wrap gap-2 mb-4">${d.away_roster.map(p => `<span class="px-3 py-1 rounded-lg bg-white/5 text-sm cursor-pointer hover:bg-primary/20 transition" onclick="showPlayerDetail(${p.id})">${p.full_name}</span>`).join('')}</div>` : ''}
        ${d.best_players?.length ? `<h3 class="font-bold mb-2 mt-4">Лучшие игроки</h3><div class="flex flex-wrap gap-2">${d.best_players.map(bp => `<span class="px-3 py-1 rounded-lg bg-amber-500/10 text-amber-400 text-sm"><span class="material-symbols-outlined text-[14px] align-middle" style="font-variation-settings:'FILL' 1">star</span> ${bp.player_name} (${bp.team || ''})</span>`).join('')}</div>` : ''}
        <div class="mt-6 pt-4 border-t border-white/5 flex justify-end"><a href="https://volleymsk.ru/match.php?id=${d.site_id}" target="_blank" rel="noopener" class="inline-flex items-center gap-1.5 text-xs text-slate-500 hover:text-primary transition"><span class="material-symbols-outlined text-sm">open_in_new</span>Источник на volleymsk.ru</a></div>`;
    document.getElementById('detail-modal').style.display = 'flex';
}

async function showPlayerDetail(id) {
    const d = await api(`/api/players/${id}`);
    document.getElementById('modal-title').textContent = d.full_name;
    document.getElementById('modal-content').innerHTML = `
        <div class="flex gap-6 mb-6">
            ${d.photo_url ? `<img src="${d.photo_url}" class="w-24 h-24 rounded-full object-cover border-2 border-white/10"/>` : `<div class="w-24 h-24 rounded-full bg-slate-700 flex items-center justify-center text-3xl font-bold text-slate-400 border-2 border-white/10">${d.full_name.split(' ').map(n=>n[0]).join('').slice(0,2)}</div>`}
            <div><p class="text-xl font-bold text-white">${d.full_name}</p><div class="flex gap-4 mt-2 text-sm text-slate-400">${d.birth_year ? `<span>Год: ${d.birth_year}</span>` : ''}${d.height ? `<span>Рост: ${d.height} см</span>` : ''}${d.position ? `<span>${d.position}</span>` : ''}</div>${d.teams?.length ? `<div class="flex gap-2 mt-3">${d.teams.map(t => `<span class="px-2 py-1 rounded-lg bg-primary/10 text-primary text-xs font-medium cursor-pointer" onclick="showTeamDetail(${t.id})">${t.name}</span>`).join('')}</div>` : ''}</div>
        </div>
        <div class="grid grid-cols-5 gap-4 mb-6">
            <div class="text-center p-3 bg-bg-dark rounded-xl"><p class="text-2xl font-bold text-white">${d.stats.total_matches}</p><p class="text-xs text-slate-500 mt-1">Матчей</p></div>
            <div class="text-center p-3 bg-bg-dark rounded-xl"><p class="text-2xl font-bold text-emerald-400">${d.stats.wins}</p><p class="text-xs text-slate-500 mt-1">Побед</p></div>
            <div class="text-center p-3 bg-bg-dark rounded-xl"><p class="text-2xl font-bold text-red-400">${d.stats.losses}</p><p class="text-xs text-slate-500 mt-1">Поражений</p></div>
            <div class="text-center p-3 bg-bg-dark rounded-xl"><p class="text-2xl font-bold text-white">${d.stats.win_rate}%</p><p class="text-xs text-slate-500 mt-1">Винрейт</p></div>
            <div class="text-center p-3 bg-bg-dark rounded-xl"><p class="text-2xl font-bold text-amber-400">${d.stats.best_player_awards}</p><p class="text-xs text-slate-500 mt-1">MVP</p></div>
        </div>
        ${d.referee_stats ? `<div class="bg-bg-dark rounded-xl p-4 mb-6"><h3 class="font-bold text-sm mb-2">Судейство</h3><p class="text-sm text-slate-400">Матчей: <span class="text-white font-bold">${d.referee_stats.matches_refereed}</span>${d.referee_stats.avg_rating ? ` | Средняя оценка: <span class="text-amber-400 font-bold">${d.referee_stats.avg_rating}</span>` : ''}</p></div>` : ''}
        ${d.matches?.length ? `<h3 class="font-bold mb-3">История матчей (${d.matches.length})</h3><div class="max-h-[300px] overflow-y-auto space-y-1">${d.matches.map(m => `<div class="flex items-center gap-3 px-3 py-2 rounded-lg ${m.is_win ? 'bg-emerald-500/5' : 'bg-red-500/5'} hover:bg-white/5 cursor-pointer text-sm" onclick="showMatchDetail(${m.id})"><span class="w-2 h-2 rounded-full ${m.is_win ? 'bg-emerald-500' : 'bg-red-500'}"></span><span class="text-slate-500 w-20">${m.date_time ? new Date(m.date_time).toLocaleDateString('ru') : '-'}</span><span class="text-white font-medium">${m.player_team}</span><span class="text-slate-500">${m.is_home ? 'vs' : '@'}</span><span class="text-slate-400">${m.opponent}</span><span class="ml-auto font-bold ${m.is_win ? 'text-emerald-400' : 'text-red-400'}">${m.score}</span></div>`).join('')}</div>` : ''}`;
    document.getElementById('detail-modal').style.display = 'flex';
}

async function showTeamDetail(id) {
    const d = await api(`/api/teams/${id}`);
    document.getElementById('modal-title').textContent = d.name;
    document.getElementById('modal-content').innerHTML = `
        <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="text-center p-4 bg-bg-dark rounded-xl"><p class="text-2xl font-bold">${d.stats.total_matches}</p><p class="text-xs text-slate-500 mt-1">Матчей</p></div>
            <div class="text-center p-4 bg-bg-dark rounded-xl"><p class="text-2xl font-bold text-emerald-400">${d.stats.wins}</p><p class="text-xs text-slate-500 mt-1">Побед</p></div>
            <div class="text-center p-4 bg-bg-dark rounded-xl"><p class="text-2xl font-bold text-red-400">${d.stats.losses}</p><p class="text-xs text-slate-500 mt-1">Поражений</p></div>
            <div class="text-center p-4 bg-bg-dark rounded-xl"><p class="text-2xl font-bold">${d.stats.win_rate}%</p><p class="text-xs text-slate-500 mt-1">Винрейт</p></div>
        </div>
        <div class="flex h-2.5 overflow-hidden rounded-full bg-black/20 mb-6"><div class="h-full bg-emerald-500" style="width:${d.stats.win_rate}%"></div><div class="h-full bg-red-500" style="width:${100 - d.stats.win_rate}%"></div></div>
        ${d.players?.length ? `<h3 class="font-bold mb-3">Игроки (${d.players.length})</h3><div class="flex flex-wrap gap-2 mb-6">${d.players.map(p => `<span class="px-3 py-1.5 rounded-lg bg-white/5 text-sm cursor-pointer hover:bg-primary/20 transition" onclick="showPlayerDetail(${p.id})">${p.full_name}</span>`).join('')}</div>` : ''}
        ${d.recent_matches?.length ? `<h3 class="font-bold mb-3">Последние матчи</h3><div class="space-y-1">${d.recent_matches.map(m => `<div class="flex items-center gap-3 px-3 py-2 rounded-lg ${m.is_win ? 'bg-emerald-500/5' : 'bg-red-500/5'} text-sm"><span class="w-2 h-2 rounded-full ${m.is_win ? 'bg-emerald-500' : 'bg-red-500'}"></span><span class="text-slate-500 w-20">${m.date_time ? new Date(m.date_time).toLocaleDateString('ru') : '-'}</span><span class="text-slate-400">${m.is_home ? 'vs' : '@'} ${m.opponent}</span><span class="ml-auto font-bold ${m.is_win ? 'text-emerald-400' : 'text-red-400'}">${m.score}</span></div>`).join('')}</div>` : ''}`;
    document.getElementById('detail-modal').style.display = 'flex';
}

// PARSING
let progressInterval = null;
async function loadParsing() {
    const stats = await api('/api/stats');
    document.getElementById('parse-db-stats').innerHTML = [
        { icon: 'sports_volleyball', label: 'Матчей', value: stats.matches, bg: 'bg-primary/10', text: 'text-primary' },
        { icon: 'person', label: 'Игроков', value: stats.players, bg: 'bg-cyan-400/10', text: 'text-cyan-400' },
        { icon: 'groups', label: 'Команд', value: stats.teams, bg: 'bg-purple-500/10', text: 'text-purple-500' },
        { icon: 'sports', label: 'Судей', value: stats.referees, bg: 'bg-orange-500/10', text: 'text-orange-500' },
    ].map(s => `<div class="flex items-center gap-4 p-4 bg-bg-dark rounded-xl"><div class="p-2 ${s.bg} rounded-lg ${s.text}"><span class="material-symbols-outlined">${s.icon}</span></div><div><p class="text-2xl font-bold text-white">${s.value?.toLocaleString()}</p><p class="text-xs text-slate-500">${s.label}</p></div></div>`).join('');
    updateProgress();
}

async function updateProgress() {
    const p = await api('/api/progress');
    const sec = document.getElementById('parse-progress');
    if (p.status === 'idle') { sec.style.display = 'none'; return; }
    sec.style.display = 'block';
    document.getElementById('parse-job-type').textContent = p.job_type === 'matches' ? 'Матчи' : 'Составы';
    document.getElementById('parse-current').textContent = p.current_id?.toLocaleString();
    document.getElementById('parse-end').textContent = p.end_id?.toLocaleString();
    document.getElementById('parse-parsed').textContent = p.total_parsed?.toLocaleString();
    document.getElementById('parse-errors').textContent = p.total_errors?.toLocaleString();
    document.getElementById('parse-percent').textContent = p.progress_percent + '%';
    document.getElementById('parse-bar').style.width = p.progress_percent + '%';
    document.getElementById('parse-last-error').textContent = p.last_error || '';
    const isActive = ['running', 'paused'].includes(p.status);
    const badge = document.getElementById('parse-status-badge'), st = document.getElementById('parse-status-text');
    if (p.status === 'running') { st.textContent = 'Выполняется'; badge.className = 'flex gap-2 px-3 py-1 rounded-full bg-emerald-500/10 border border-emerald-500/20'; st.className = 'text-xs font-bold text-emerald-500 uppercase'; }
    else if (p.status === 'paused') { st.textContent = 'Пауза'; badge.className = 'flex gap-2 px-3 py-1 rounded-full bg-amber-500/10 border border-amber-500/20'; st.className = 'text-xs font-bold text-amber-500 uppercase'; }
    else if (p.status === 'completed') { st.textContent = 'Завершено'; badge.className = 'flex gap-2 px-3 py-1 rounded-full bg-blue-500/10 border border-blue-500/20'; st.className = 'text-xs font-bold text-blue-500 uppercase'; }
    else { st.textContent = p.status === 'stopped' ? 'Остановлено' : 'Ошибка'; badge.className = 'flex gap-2 px-3 py-1 rounded-full bg-red-500/10 border border-red-500/20'; st.className = 'text-xs font-bold text-red-500 uppercase'; }
    document.getElementById('btn-pause').style.display = p.status === 'running' ? 'inline-flex' : 'none';
    document.getElementById('btn-resume').style.display = p.status === 'paused' ? 'inline-flex' : 'none';
    document.getElementById('btn-stop').style.display = isActive ? 'inline-flex' : 'none';
    if (isActive && !progressInterval) progressInterval = setInterval(updateProgress, 1000);
    if (['completed', 'stopped', 'failed'].includes(p.status)) { clearInterval(progressInterval); progressInterval = null; loadParsing(); }
}

function startProgressPolling() { if (progressInterval) clearInterval(progressInterval); progressInterval = setInterval(updateProgress, 1000); updateProgress(); }

document.getElementById('btn-parse-matches').addEventListener('click', async () => {
    await apiPost('/api/parse/matches', { start_id: parseInt(document.getElementById('parse-match-start').value), end_id: parseInt(document.getElementById('parse-match-end').value), skip_existing: document.getElementById('parse-skip-existing').checked });
    startProgressPolling();
});
document.getElementById('btn-parse-rosters').addEventListener('click', async () => {
    await apiPost('/api/parse/rosters', { start_id: parseInt(document.getElementById('parse-roster-start').value), end_id: parseInt(document.getElementById('parse-roster-end').value) });
    startProgressPolling();
});
document.getElementById('btn-pause').addEventListener('click', () => apiPost('/api/parse/pause'));
document.getElementById('btn-resume').addEventListener('click', () => apiPost('/api/parse/resume'));
document.getElementById('btn-stop').addEventListener('click', () => apiPost('/api/parse/stop'));

let searchTimeout = null;
function setupSearch(id, fn) { const el = document.getElementById(id); if (el) el.addEventListener('input', () => { clearTimeout(searchTimeout); searchTimeout = setTimeout(fn, 300); }); }
setupSearch('match-search', () => loadMatches(1));
setupSearch('teams-search', loadTeams);
setupSearch('players-search', () => loadPlayers(1));
setupSearch('referees-search', loadReferees);

navigateTo('dashboard');
updateProgress();
</script>
</body>
</html>
