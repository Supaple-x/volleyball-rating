# VolleyMSK Parser

Парсер данных с сайта volleymsk.ru (Любительская Волейбольная Лига).

## Текущее состояние

**Статус:** Работает, протестирован на реальных данных.

**Последнее обновление:** 04.02.2026
- Добавлены детальные карточки матчей, команд, игроков
- Фото игроков в тултипах и списках
- Исправлен парсинг составов из members.php
- Исправлено сохранение лучших игроков матча

## Что парсится

### Из страницы матча (`match.php?match_id=XXX`)
- Команды (название, site_id)
- Счёт матча (общий и по сетам)
- Дата и время
- Турнирный путь (Регулярный турнир > Мужской турнир > Сезон > Лига > Круг)
- Судья (ФИО)
- Оценка судейства (от хозяев и гостей, числовая + текстовая)
- Лучшие игроки матча
- Составы команд (ID игроков, ФИО, фото URL)

### Из страницы состава (`members.php?id=XXX`)
- Список игроков с детальной информацией
- Рост, позиция, год рождения
- Фото URL
- Средний рост и возраст команды

## Структура проекта

```
volleyball-rating/
├── run.py                    # Точка входа (web/cli)
├── requirements.txt          # Зависимости Python
├── test_parser.py           # Тестовый скрипт
├── debug_html.py            # Сохранение HTML для отладки
├── data/
│   └── volleyball.db        # SQLite база данных
└── src/
    ├── database/
    │   ├── models.py        # SQLAlchemy модели
    │   └── db.py            # Работа с БД
    ├── parser/
    │   ├── base_parser.py   # Базовый класс (HTTP, rate limiting)
    │   ├── match_parser.py  # Парсер матчей
    │   ├── team_parser.py   # Парсер команд
    │   └── roster_parser.py # Парсер составов
    ├── services/
    │   ├── data_service.py     # Сохранение в БД
    │   └── parsing_service.py  # Координация парсинга (фоновые задачи)
    └── web/
        ├── app.py              # Flask приложение + API
        ├── templates/index.html
        └── static/css/style.css
```

## Схема базы данных

### Основные таблицы
- `matches` - матчи (site_id, дата, счёт, судья, оценки)
- `teams` - команды (site_id, название)
- `players` - игроки (site_id, ФИО, рост, позиция, год рождения, photo_url)
- `referees` - судьи (ФИО)
- `match_players` - связь матч-игрок (состав на матч)
- `best_players` - лучшие игроки матча (player_id nullable, player_name fallback)

### Турнирная структура
- `seasons` - сезоны (2025-2026)
- `tournaments` - турниры
- `leagues` - лиги (Суперлига, Высшая, Первая...)
- `rounds` - круги/этапы

### Служебные
- `team_rosters` - исторические составы (из members.php)
- `parsing_jobs` - журнал задач парсинга

## Запуск

### Установка
```bash
cd c:\Dev\volleyball-rating
pip install -r requirements.txt
```

### Веб-интерфейс
```bash
python run.py web
# Открыть http://127.0.0.1:5000
```

### CLI парсинг
```bash
python run.py parse --start 1 --end 1000
```

### Тест одного матча
```bash
python test_parser.py 42131
```

## Веб-интерфейс

### Основные функции
- Статистика БД (матчи, команды, игроки, судьи)
- Управление парсингом (старт, пауза, стоп)
- Просмотр списков данных с пагинацией

### Детальные карточки
- **Клик по матчу** → карточка с составами, судьёй, лучшими игроками
- **Клик по команде** → статистика, список игроков, последние матчи
- **Наведение на игрока** → тултип с фото и информацией

## API эндпоинты

### Списки
| Метод | URL | Описание |
|-------|-----|----------|
| GET | `/api/stats` | Статистика БД |
| GET | `/api/matches?page=1` | Список матчей |
| GET | `/api/teams` | Список команд |
| GET | `/api/players?page=1` | Список игроков |
| GET | `/api/referees` | Список судей |

### Детальная информация
| Метод | URL | Описание |
|-------|-----|----------|
| GET | `/api/matches/<id>` | Матч с составами |
| GET | `/api/teams/<id>` | Команда со статистикой |
| GET | `/api/players/<id>` | Игрок с фото и матчами |

### Управление парсингом
| Метод | URL | Описание |
|-------|-----|----------|
| GET | `/api/progress` | Прогресс парсинга |
| POST | `/api/parse/matches` | Начать парсинг матчей |
| POST | `/api/parse/rosters` | Начать парсинг составов |
| POST | `/api/parse/pause` | Пауза |
| POST | `/api/parse/resume` | Продолжить |
| POST | `/api/parse/stop` | Остановить |

## Технические детали

### Rate limiting
- 0.5 секунды между запросами
- Настраивается в `BaseParser.RATE_LIMIT`

### Кодировка сайта
- windows-1251 (автоматически конвертируется)

### HTML структура volleymsk.ru
- Таблицы с `bgcolor="#CCCCCC"` содержат данные матча
- ID игроков извлекаются из URL фото: `/uploads/player/t/{ID}.PNG`
- Нет ссылок `player.php` на страницах матча и состава

### Фото игроков
- URL: `https://volleymsk.ru/uploads/player/t/{ID}.{ext}`
- Расширения: PNG, JPG, jpeg
- Извлекаются из match.php и members.php

### Известные ID
- Матчи: до 42131+ (актуально на 02.2026)
- Команды: 536 (INEX team), 620 (КПРФ Москва)
- Турниры: 1892 (Суперлига сезон 25/26)

## TODO / Идеи на будущее

- [ ] Экспорт данных в CSV/Excel
- [ ] Поиск и фильтрация в веб-интерфейсе
- [x] Статистика игроков (количество матчей) - сделано в карточке игрока
- [ ] Рейтинг судей по оценкам
- [ ] Парсинг турнирных таблиц (trntable.php)
- [ ] Парсинг расписания (rasp.php)
- [ ] Миграция в PostgreSQL для облака
- [ ] Кеширование API ответов
